# 事件发生[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-3 "永久链接至标题")

运维监控人员、客服审核人员等发现问题，向上通报。

## 事件确认[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-4 "永久链接至标题")

收集事件信息、分析网络活动相关程序，日志和数据，判断事件的严重性，评估出问题的严重等级，是否向上进行汇报等。

## 事件响应[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-5 "永久链接至标题")

各部门通力合作，处理安全问题，具体解决问题，避免存在漏洞未修补、后门未清除等残留问题。

## 事件关闭[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-6 "永久链接至标题")

处理完事件之后，需要关闭事件，并写出安全应急处理分析报告，完成整个应急过程。

## 事件分类[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-7 "永久链接至标题")

- 病毒、木马、蠕虫事件
- Web服务器入侵事件
- 第三方服务入侵事件
- 系统入侵事件
    
    - 利用Windows漏洞攻击操作系统
    
- 网络攻击事件
    
    - DDoS / ARP欺骗 / DNS劫持等

# 分析方向[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-8 "永久链接至标题")

## 文件分析[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-9 "永久链接至标题")

- 基于变化的分析
    
    - 日期
    - 文件增改
    - 最近使用文件
    
- 源码分析
    
    - 检查源码改动
    - 查杀WebShell等后门
    
- 系统日志分析
- 应用日志分析
    
    - 分析User-Agent，e.g. `awvs / burpsuite / w3af / nessus / openvas`
    - 对每种攻击进行关键字匹配，e.g. `select/alert/eval`
    - 异常请求，连续的404或者500
    
- `md5sum` 检查常用命令二进制文件的哈希，检查是否被植入rootkit


## 进程分析[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-10 "永久链接至标题")

- 符合以下特征的进程
    
    - CPU或内存资源占用长时间过高
    - 没有签名验证信息
    - 没有描述信息的进程
    - 进程的路径不合法
    
- dump系统内存进行分析
- 正在运行的进程
- 正在运行的服务
- 父进程和子进程
- 后台可执行文件的完整哈希
- 已安装的应用程序
- 运行着密钥或其他正在自动运行的持久化程序
- 计划任务

## 身份信息分析[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-11 "永久链接至标题")

- 本地以及域账号用户
- 异常的身份验证
- 非标准格式的用户名

## 日志分析[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-12 "永久链接至标题")

- 杀软检测记录

## 网络分析[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-13 "永久链接至标题")

- 防火墙配置
- DNS配置
- 路由配置
- 监听端口和相关服务
- 最近建立的网络连接
- RDP / VPN / SSH 等会话

## 配置分析[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-14 "永久链接至标题")

- 查看Linux SE等配置
- 查看环境变量
- 查看配套的注册表信息检索，SAM文件
- 内核模块
#  日志分析

日志分析是收集、解析和处理日志文件并将数据转化为可操作的知识，以检测安全威胁和异常并识别系统性能问题。
## 科普
数据的核心：日志

日志是系统内事件的记录。这些记录详细说明了系统所做的事情，记录了各种事件，例如用户登录、文件访问、系统错误、网络连接以及数据或系统配置的更改。

日志条目通常包含以下信息：

- 记录事件的时间戳
- 生成日志条目的系统或应用程序的名称
- 发生事件的类型
- 有关事件的其他详细信息，例如发起事件的用户或生成事件的设备 IP 地址

日志 上下文关联

单个日志条目本身可能看起来微不足道。但是，当日志数据被汇总、分析并与其他信息源交叉引用时，它就变成了一种强大的调查工具。日志可以回答有关事件的关键问题，例如：

- **发生了什么**？what
- **什么时候**发生的？when
- **在哪**发生的？where
- **谁**该负责？who
- 他们的行动**成功了****吗**？seccessful?
- **他们的行动产生了什么**结果？action?

## 数据源  

需要处理的日志源多种多样，因此对它们进行分类是一个很好的开始。数据源可分为两大类。

|              |                                                                                                                                                                                                                                                              |
| ------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Physical** | - 托管关键系统的设施/区域。<br>- 安全摄像头监控和物理进出访问日志：<br>    - 系统控制室<br>    - 辦公室                                                                                                                                                                                           |
| **Virtual**  | - 网络组件<br>    - 路由器和交换机<br>    - 插入式设备<br>- 操作系统<br>- 服务器<br>- 安全设备<br>    - 防火墙<br>    - 防病毒/恶意软件<br>    - 入侵检测系统/入侵防御系统<br>    - 数字流程处理<br>    - VPN<br>- 应用程序和框架<br>    - web<br>    - Java<br>    - PHP<br>    - Python<br>- 移动设备<br>- 虚拟化和云组件。<br>- 数据库 |

最常见的日志类型的列表：

| **应用程序日志** Application Logs:      | 有关特定应用程序的消息，包括状态、错误、警告等     |
| --------------------------------- | --------------------------- |
| **审计日志** **Audit Logs**           | 与法规遵从性至关重要的操作程序相关的活动        |
| **安全日志** **Security Logs**        | 安全事件，例如登录、权限更改、防火墙活动等       |
| **服务器日志** **Server Logs**         | 服务器生成的各种日志，包括系统、事件、错误和访问日志。 |
| **系统日志** **System Logs**          | 内核活动、系统错误、启动顺序和硬件状态。        |
| **网络日志** **Network Logs**         | 网络流量、连接和其他与网络相关的事件。         |
| **数据库日志** **Database Logs**       | 数据库系统内的活动，例如查询和更新。          |
| **Web 服务器日志** **Web Server Logs** | Web 服务器处理的请求，包括 URL、响应代码等。  |

## 日志格式

### **半结构化日志：

**这些日志可能包含结构化和非结构化数据，其中可预测的组件可容纳自由格式的文本。示例包括：

#### - **Syslog 消息格式：
**一种广泛采用的系统和网络日志日志协议。
    ```shell-session
    damianhall@WEBSRV-02:~/logs$ cat syslog.txt
    May 31 12:34:56 WEBSRV-02 CRON[2342593]: (root) CMD ([ -x /etc/init.d/anacron ] && if [ ! -d /run/systemd/system ]; then /usr/sbin/invoke-rc.d anacron start >/dev/null; fi)
    ```
  
#### - **Windows 事件日志 ( EVTX ) 格式：** 
**Windows 系统专有的 Microsoft 日志。**
```
PS C:\WINDOWS\system32> Get-WinEvent -Path "C:\Windows\System32\winevt\Logs\Application.evtx"
    
    
       ProviderName: Microsoft-Windows-Security-SPP
    
    TimeCreated                      Id LevelDisplayName Message
    -----------                      -- ---------------- -------
    31/05/2023 17:18:24           16384 Information      Successfully scheduled Software Protection service for re-start
    31/05/2023 17:17:53  
```
### - **结构化日志：
- **遵循严格、标准化的格式，便于解析和分析。典型的结构化日志格式包括：
##### 1.  **字段分隔格式
**逗号分隔值 (CSV) 和制表符分隔值 (TSV) 是表格数据常使用的格式。

```
damianhall@WEBSRV-02:~/logs$ cat log.csv "time","user","action","status","ip","uri" "2023-05-31T12:34:56Z","adversary","GET",200,"34.253.159.159","http://gitlab.swiftspend.finance:80/"
```
##### 2. **JavaScript 对象表示法（JSON）**
**以其可读性和与现代编程语言的兼容性而闻名。

```
damianhall@WEBSRV-02:~/logs$ cat log.json {"time": "2023-05-31T12:34:56Z", "user": "adversary", "action": "GET", "status": 200, "ip": "34.253.159.159", "uri": "http://gitlab.swiftspend.finance:80/"}
```

##### **3. W3C 扩展日志格式 (ELF)**
**由万维网联盟 (W3C) 定义，可自定义用于 Web 服务器日志记录。它通常由 Microsoft Internet Information Services (IIS) Web 服务器使用。

```
damianhall@WEBSRV-02:~/logs$ cat log.json {"time": "2023-05-31T12:34:56Z", "user": "adversary", "action": "GET", "status": 200, "ip": "34.253.159.159", "uri": "http://gitlab.swiftspend.finance:80/"}
```
##### 4.**可扩展标记语言（XML）：
**灵活且可定制，用于创建标准化日志格式。
```
damianhall@WEBSRV-02:~/logs$ cat log.xml <log><time>2023-05-31T12:34:56Z</time><user>adversary</user><action>GET</action><status>200</status><ip>34.253.159.159</ip><url>https://gitlab.swiftspend.finance/</url></log>
```

### **非结构化日志：
**这些日志由自由格式的文本组成，可能包含丰富的上下文，但可能对系统解析造成挑战。示例包括：

##### 1.**NCSA 通用日志格式 (CLF)**
**客户端请求的标准化 Web 服务器日志格式。Apache HTTP Server 通常默认使用此 格式。

```
damianhall@WEBSRV-02:~/logs$ cat clf.log 34.253.159.159 - adversary [31/May/2023:13:55:36 +0000] "GET /explore HTTP/1.1" 200 4886
```
##### 2. - **NCSA 组合日志格式（Combined）**
CLF 的扩展，添加了 referrer 和 user agent 等字段。通常由 Nginx** HTTP Server 默认使用。

```
damianhall@WEBSRV-02:~/logs$ cat clf.log 34.253.159.159 - adversary [31/May/2023:13:55:36 +0000] "GET /explore HTTP/1.1" 200 4886
```

## 日志存储
存储位置的选择通常取决于多种因素：

- **安全要求：确保日志存储符合组织或监管安全协议。
- **可访问性需求：日志的访问速度和访问对象会影响存储的选择。
- **存储容量：生成的日志量可能需要大量的存储空间，从而影响存储解决方案的选择。
- **成本考虑：日志存储的预算可能会决定基于云或本地解决方案的选择。
- **合规法规：管理日志存储的特定行业法规可能会影响存储的选择。
- **保留政策：所需的保留时间和检索的难易程度会影响决策过程。
- **灾难恢复计划** ：即使在系统故障的情况下确保日志的可用性可能需要特定的存储解决方案

## 日志保存

- **热存储：**过去**3-6 个月**内最易访问的日志。查询速度应接近实时，具体取决于查询的复杂性。
- **温存储：**保存**六个月到两年的**日志，充当数据湖，易于访问，但不像热存储那样即时。
- **冷存储：**存档或压缩的日志，保存时间为**2-5 年**。这些日志不易访问，通常用于追溯分析或确定范围。

## 日志分析工具

安全信息和事件管理 ( SIEM ) 工具（例如Splunk或 Elastic Search）可用于复杂的日志分析任务。

然而，在需要立即进行数据分析的情况下，例如在事件响应期间，基于Linux的系统可以使用默认工具（如 `grep`，`sed`，`sort`，`uniq`，`awk`，`sha256sum`）以及对日志文件进行哈希处理。基于 Windows 的系统可以使用[EZ-Tools](https://ericzimmerman.github.io/#!index.md)和默认 cmdlet，`Get-FileHash`来实现类似目的。这些工具可以快速解析和分析，非常适合这些情况。[

## 日志分析技术

日志分析技术是用于解释日志数据并从中获取见解的方法或实践。这些技术范围从简单到复杂，对于识别模式、异常和关键见解至关重要。以下是一些常用技术：

### **模式识别：

**这涉及识别日志数据中的重复序列或趋势。它可以检测常规系统行为或识别可能表明存在安全威胁的异常活动。

### **异常检测：
**异常检测专注于识别偏离预期模式的数据点。尽早发现潜在问题或恶意活动至关重要。

### **关联分析：
**关联不同的日志条目有助于了解各种事件之间的关系。它可以揭示系统组件之间的因果关系和依赖关系，对于根本原因分析至关重要。

### **时间线分析：
**分析一段时间内的日志有助于了解趋势、季节性和周期性行为。这对于性能监控和预测系统负载至关重要。

### **机器学习和人工智能：
**利用机器学习模型可以自动化和增强各种日志分析技术，例如分类和丰富。人工智能可以提供预测性见解并帮助自动响应特定事件。

### **可视化：
**通过图形和图表呈现日志数据可以实现直观理解和快速洞察。可视化可以使复杂数据更易于理解，并有助于识别关键模式和关系。

### **统计分析：
**使用统计方法分析日志数据可以提供定量见解并帮助做出数据驱动的决策。回归分析和假设检验可以推断关系并验证假设。

这些技术可以单独应用，也可以组合应用，具体取决于日志分析任务的具体要求和复杂性。了解和使用这些技术可以显著提高日志分析的有效性，从而做出更明智的决策和采取更强大的安全措施。

## 未解析的原始日志文件

处理原始日志文件时，您可以通过在 URL 中指定路径直接通过日志查看器工具访问它们。以下是包含多个日志文件的示例 URL：

```yaml
http://10.10.15.92:8111/log?log=%2Fvar%2Flog%2Fgitlab%2Fnginx%2Faccess.log&log=%2Fvar%2Flog%2Fwebsrv-02%2Frsyslog_cron.log&log=%2Fvar%2Flog%2Fwebsrv-02%2Frsyslog_sshd.log&log=%2Fvar%2Flog%2Fgitlab%2Fgitlab-rails%2Fapi_json.log
```

[将此 URL 粘贴到您的浏览器中，以使用日志查看器](https://github.com/sevdokimov/log-viewer)工具 查看未解析的原始日志文件。

# Windows 日志
Windows 事件日志不是可以使用文本编辑器查看的文本文件。但是，可以使用 Windows API将原始数据转换为XML。这些日志文件中的事件以专有二进制格式存储，扩展名为 .evt 或.evtx 。文件扩展名为.evtx的日志文件通常位于 `C:\Windows\System32\winevt\Logs`中。

## 查看日志
在 Windows 系统中访问这些事件日志的主要方法有三种：

1. **事件查看器**（基于GUI的应用程序）
2. **Wevtutil.exe**（命令行工具）
3. **Get-WinEvent**（PowerShell cmdlet）

###  1. 事件查看器
在任何 Windows 系统中，只需右键单击任务栏中的 Windows 图标并选择事件查看器，即可启动**事件查看器****（Microsoft 管理控制台 (MMC) 管理单元）** 。对于每天大部分时间使用CLI的精明系统管理员来说，可以通过键入`eventvwr.msc`来启动事件查看器。它是一个基于GUI的应用程序，允许您快速与日志交互并分析日志。、

窗格的每一列都显示一种特定类型的信息，如下所述：

- **级别**：根据先前指定的已识别事件类型突出显示日志记录类型。在本例中，日志标记为**信息**。
- **日期和时间**：突出显示记录事件的时间。
- **来源**：标识记录事件的软件名称。从上图可以看出，来源是PowerShell。
- **事件 ID**：这是根据日志源映射到特定操作或事件的预定义数值。这使得事件ID不唯一，因此`Event ID 4103` 在上图中与执行管道相关，但在另一个事件日志中具有完全不同的含义。
- **任务类别**：突出显示事件类别。此条目将帮助您组织事件，以便事件查看器可以过滤它们。事件源定义此列。

### 2. **wevtutil.exe**

wevtuil.exe 加el参数 列出日志名 

measure-object 统计数目

### 3.**Get-WinEvent**
是PowerShell cmdlet 

Get-WinEvent -ListLog * 
获得所有日志

Get-WinEvent -ListProvider * 
生成事件日志提供程序及其相关日志。

Get-WinEvent -ListProvider * name*
生成制定文件名的相关日志

Get-WinEvent -LogName Application | Where-Object { $_.ProviderName -Match 'WLMS' }
日志过滤


## 日志类型

| 日志类型       | 用法                                                      | 例子                                                                     |
| ---------- | ------------------------------------------------------- | ---------------------------------------------------------------------- |
| **系统日志**   | 系统日志有助于解决操作系统中的运行问题。这些日志提供有关各种操作系统活动的信息。                | - 系统启动和关闭事件  <br> - 驱动程序加载事件  <br> - 系统错误事件  <br> - 硬件事件               |
| **安全日志**   | 安全日志有助于检测和调查事件。这些日志提供有关系统中与安全相关的活动的信息。                  | - 身份验证事件  <br> - 授权事件  <br> - 安全策略更改事件  <br> - 用户帐户更改事件  <br> - 异常活动事件 |
| **应用程序日志** | 应用程序日志包含与应用程序相关的特定事件。应用程序内部发生的任何交互式或非交互式活动都将记录在此处。      | - 用户交互事件  <br> - 应用程序更改事件  <br> - 应用程序更新事件  <br> - 应用程序错误事件            |
| **审计日志**   | 审计日志提供有关系统更改和用户事件的详细信息。这些日志有助于满足合规性要求，并且在安全监控中也能发挥重要作用。 | - 数据访问事件  <br> - 系统变更事件  <br> - 用户活动事件  <br> - 策略执行事件                  |
| **网络日志**   | 网络日志提供有关网络传出和传入流量的信息。它们在解决网络问题时起着至关重要的作用，在事件调查期间也很有用。   | - 传入网络流量事件  <br> - 传出网络流量事件  <br> - 网络连接日志  <br> - 网络防火墙日志             |
| **访问日志**   | 访问日志提供有关访问不同资源的详细信息。这些资源可以属于不同类型，为我们提供有关其访问的信息。         | - Web 服务器访问日志  <br> - 数据库访问日志  <br> - 应用程序访问日志  <br> - API 访问日志        |

### 重要事件ID
以下是Windows 操作系统中一些的表格。

Windows操作系统有一个称为事件查看器的实用程序，它提供了一个良好的图形用户界面来查看和搜索这些日志中的任何内容。

|          |                                                                                                                                                        |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **活动类别** | **事件 ID 和详细信息**                                                                                                                                        |
| 帐户管理     | - 4720：用户账户创建。<br>- 4722：用户帐户已启用。<br>- 4723：尝试更改帐户密码。<br>    - 用户尝试更改其密码。<br>- 4724：尝试重置账户密码。<br>    - 用户尝试重置另一个账户的密码。<br>- 4725：帐户禁用。<br>- 4726：删除帐户。 |
| 账户登录     | - 4624：登录成功。<br>- 4625：登录失败。<br>- 4634 和 4647：注销。<br>- 4779：会话断开。                                                                                      |
| 计划任务     | - 4698：计划任务创建。<br>- 4702：计划任务已更新。<br>- 4699：计划任务删除。                                                                                                    |
| 安全       | - 1100：日志服务已禁用。<br>- 1102：日志删除。<br>- 1116：恶意软件检测。                                                                                                      |

## Windows 事件日志剖析

Windows 事件日志提供有关 Windows 操作系统上安装的系统、安全性和应用程序的深入足迹信息。Windows 提供了大量的日志，您需要根据自己的可见性需求和容量激活它们。

|                    |                                                                                                                                                                                                  |
| ------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 格式  <br>/  <br>扩展名 | - 默认格式/扩展名：<br>    - .evt<br>    - .evtx​<br>- 可以提取以下格式：<br>    - .xml​<br>    - .csv<br>    - .TXT                                                                                              |
| **文件位置**           | - 日志文件的目录会根据 Windows操作系统版本而有所不同。MS Windows 在 Windows Vista 中更改了事件日志文件的目录/位置。<br>- 2003 及更早版本：<br>    - `C:\WINDOWS\system32\config`<br>- Vista 及更高版本：<br>    - `C:\WINDOWS\System32\winevt\Logs` |
| **查看工具**           | - **默认：**<br>    - 事件查看器- Event Viewer<br>- 也可以使用替代工具。                                                                                                                                           |
## 日志类
## Windows 事件日志的元素

事件日志对于解决任何计算机事件都至关重要，有助于了解情况并了解如何补救事件。要很好地了解这一情况，您必须首先了解信息的呈现格式。Windows 提供了一种标准化的方式来传递此系统信息。

首先，我们需要知道 Windows 系统中的事件日志由哪些元素组成。这些元素包括：

- **系统日志**：记录与操作系统段相关的事件。它们可能包括有关硬件更改、设备驱动程序、系统更改以及与设备相关的其他活动的信息。

- **安全日志**：记录与设备上的登录和注销活动相关的事件。系统的审计策略指定这些事件。日志是分析师调查企图或成功的未经授权活动的绝佳来源。

- **应用程序日志**：记录与系统上安装的应用程序相关的事件。主要信息包括应用程序错误、事件和警告。

- **目录服务事件：** Active Directory 的更改和活动记录在这些日志中，主要在域控制器上。

- **文件复制服务事件**：记录在将组策略和登录脚本共享到域控制器期间与 Windows 服务器相关的事件，用户可以通过客户端服务器从域控制器访问它们。

- **DNS事件日志**：DNS服务器使用这些日志来记录域事件并映射

- **自定义日志**：需要自定义数据存储的应用程序会记录事件。这允许应用程序控制日志大小或附加其他参数（例如 ACL），以达到安全目的。


## windows取证
### 注册表取证

注册表都包含以下五个根键：

1. HKEY_CURRENT_USER
2. HKEY_USERS
3. HKEY_LOCAL_MACHINE
4. HKEY_CLASSES_ROOT
5. HKEY_CURRENT_CONFIG

| Folder/predefined key  | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| ---------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **HKEY_CURRENT_USER**  | 包含当前登录用户的配置信息根目录。用户的文件夹、屏幕颜色和控制面板设置都存储在此处。此信息与用户的配置文件相关联。此键有时缩写为 HKCU。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| **HKEY_USERS**         | 包含计算机上所有主动加载的用户配置文件。HKEY_CURRENT_USER 是 HKEY_USERS 的子键。HKEY_USERS 有时缩写为 HKU。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| **HKEY_LOCAL_MACHINE** | Contains configuration information particular to the computer (for any user). This key is sometimes abbreviated as HKLM.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| **HKEY_CLASSES_ROOT**  | 是 的子项`HKEY_LOCAL_MACHINE\Software` 。此处存储的信息可确保使用 Windows 资源管理器打开文件时打开正确的程序。此键有时缩写为 HKCR。<br><br>从 Windows 2000 开始，此信息存储在 HKEY_LOCAL_MACHINE 和 HKEY_CURRENT_USER 项下。该项`HKEY_LOCAL_MACHINE\Software\Classes` 包含可应用于本地计算机上所有用户的默认设置。该项`HKEY_CURRENT_USER\Software\Classes` 具有覆盖默认设置并仅适用于交互式用户的设置。<br><br>HKEY_CLASSES_ROOT 键提供了注册表视图，该视图合并了来自这两个来源的信息。HKEY_CLASSES_ROOT 还为针对早期版本的 Windows 设计的程序提供了此合并视图。要更改交互式用户的设置，必须在 HKEY_CLASSES_ROOT 下进行更改，`HKEY_CURRENT_USER\Software\Classes` 而不是在 HKEY_CLASSES_ROOT 下进行更改。<br><br>要更改默认设置，必须在下进行更改`HKEY_LOCAL_MACHINE\Software\Classes`  。如果您将键写入 HKEY_CLASSES_ROOT 下的键，系统会将信息存储在下`HKEY_LOCAL_MACHINE\Software\Classes` 。<br><br>如果您向 HKEY_CLASSES_ROOT 下的某个键写入值，并且该键已经存在于 下`HKEY_CURRENT_USER\Software\Classes` ，则系统会将信息存储在那里，而不是 下`HKEY_LOCAL_MACHINE\Software\Classes` 。<br><br><br><br><br><br> |
### 脱机访问注册表配置单元

#### 注册表
必须知道注册表配置单元在磁盘上的位置。这些配置单元中的大多数位于目录中，`C:\Windows\System32\Config`并且是：

1. **默认**（安装在 上`HKEY_USERS\DEFAULT`）
2. **SAM**（安装在`HKEY_LOCAL_MACHINE\SAM`）
3. **安全**（安装在`HKEY_LOCAL_MACHINE\Security`）
4. **软件**（安装在`HKEY_LOCAL_MACHINE\Software`）
5. **SYSTEM**（安装在`HKEY_LOCAL_MACHINE\System`）

#### 配置文件 
对于 Windows 7 及更高版本，用户的配置文件目录位于`C:\Users\<username>\`配置单元所在的位置：

1. **NTUSER.DAT**（用户登录时安装在 HKEY_CURRENT_USER 上）  
NTUSER.DAT 配置单元位于目录中 `C:\Users\<username>\`。

2. **USRCLASS.DAT**（安装在 HKEY_CURRENT_USER\Software\CLASSES 上）
USRCLASS.DAT 配置单元位于目录中`C:\Users\<username>\AppData\Local\Microsoft\Windows`。

请记住，NTUSER.DAT 和 USRCLASS.DAT 是隐藏文件。

#### **Amcache ：**

除了这些文件之外，还有另一个非常重要的配置单元，称为 AmCache 配置单元。此配置单元位于 `C:\Windows\AppCompat\Programs\Amcache.hve`。Windows 创建此配置单元来保存有关最近在系统上运行的程序的信息。

SAM 配置单元的事务日志将位于`C:\Windows\System32\Config`文件名 SAM.LOG 中。有时也可能有多个事务日志。在这种情况下，它们的扩展名为 .LOG1、.LOG2 等。在执行注册表取证时，查看事务日志也是明智的做法。

注册表备份与事务日志相反。这些是目录中注册表配置单元的备份 。这些配置单元每十天`C:\Windows\System32\Config`复制到 目录中一次。如果您怀疑某些注册表项可能最近被删除/修改，这可能是查看的好地方。`C:\Windows\System32\Config\RegBack`

## 系统信息和系统账户

### 用户分析[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-19 "永久链接至标题")

- 查看是否有新增用户
- 查看服务器是否有弱口令
- 查看管理员对应键值
- `lusrmgr.msc` 查看账户变化
- `net user` 列出当前登录账户
- `wmic UserAccount get` 列出当前系统所有账

### 操作系统版本
要查找操作系统版本，我们可以使用以下注册表项：

`SOFTWARE\Microsoft\Windows NT\CurrentVersion`

### **当前控制集：**

包含用于控制系统启动的计算机配置数据的配置单元称为控制集。通常，我们会在计算机的 SYSTEM 配置单元中看到两个控制集，ControlSet001 和 ControlSet002。在大多数情况下（但并非总是），ControlSet001 将指向计算机启动时使用的控制集，而 ControlSet002 将是`last known good`  配置。它们的位置将是：

`SYSTEM\ControlSet001`

`SYSTEM\ControlSet002`

当机器处于活动状态时，Windows 会创建一个易失性控制集，称为 CurrentControlSet ( `HKLM\SYSTEM\CurrentControlSet` )。

`last known good` 可以使用以下注册表值找到配置：SYSTEM\Select\LastKnownGood

### **计算机名：**

在进行取证分析时，确定计算机名称至关重要，以确保我们在应该工作的机器上工作。我们可以从以下位置找到计算机名称：

`SYSTEM\CurrentControlSet\Control\ComputerName\ComputerName`

### **时区信息：**

为了准确起见，确定计算机所在的时区非常重要。这将有助于我们了解事件发生的年表。要查找时区信息，我们可以查看以下位置：

`SYSTEM\CurrentControlSet\Control\TimeZoneInformation`

### **网络接口和过去的网络：**

以下注册表项将提供我们正在调查的机器上的网络接口列表：

`SYSTEM\CurrentControlSet\Services\Tcpip\Parameters\Interfaces`

可以在以下位置找到给定机器过去连接的网络：

`SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Signatures\Unmanaged`

`SOFTWARE\Microsoft\Windows NT\CurrentVersion\NetworkList\Signatures\Managed`

### **自动启动程序（Autoruns）：**

以下注册表项包含有关用户登录时运行的程序或命令的信息。 

`NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Run`

`NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\RunOnce`

`SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce`

`SOFTWARE\Microsoft\Windows\CurrentVersion\policies\Explorer\Run`

`SOFTWARE\Microsoft\Windows\CurrentVersion\Run`

## 安装软件

`SOFTWARE\Microsoft\Windows\CurrentVersion\search\recentapps

### **SAM 配置单元和用户信息：**

SAM 配置单元包含用户帐户信息、登录信息和组信息。这些信息主要位于以下位置：

`SAM\Domains\Account\Users`

这里包含的信息包括用户的相对标识符 (RID)、用户登录的次数、上次登录时间、上次登录失败、上次更改密码、密码过期、密码策略和密码提示以及用户所属的任何组。

## 文件和文件夹

### **最近的文件：**

Windows 为每个用户维护最近打开的文件列表。正如我们在使用 Windows 资源管理器时可能看到的那样，它向我们显示了最近使用的文件列表。此信息存储在 NTUSER 配置单元中，可以在以下位置找到：

`NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs`

注册表项中另一个有趣的信息是，存在具有文件扩展名的不同项，例如  `.pdf` 、等`.jpg` 。`.docx`  这些项为我们提供了有关特定文件扩展名的最后使用的文件的信息。因此，如果我们专门查找最后使用的 PDF 文件，我们可以查看以下注册表项：

`NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\RecentDocs\.pdf`

### **Office 最近的文件：**

与 Windows 资源管理器维护的“最近打开的文档”类似，Microsoft Office 也维护最近打开的文档列表。此列表也位于 NTUSER 配置单元中。可以在以下位置找到它：

`NTUSER.DAT\Software\Microsoft\Office\VERSION`

每个 Microsoft Office 版本的版本号都不同。示例注册表项如下所示：

`NTUSER.DAT\Software\Microsoft\Office\15.0\Word`

[这里的 15.0 指的是 Office 2013。在此链接](https://docs.microsoft.com/en-us/deployoffice/install-different-office-visio-and-project-versions-on-the-same-computer#office-releases-and-their-version-number)上可以找到不同 Office 版本及其版本号的列表。

从 Office 365 开始，微软将位置与用户的[live ID](https://www.microsoft.com/security/blog/2008/05/07/what-is-a-windows-live-id/)绑定在一起。在这种情况下，可以在以下位置找到最近的文件。 

`NTUSER.DAT\Software\Microsoft\Office\VERSION\UserMRU\LiveID_####\FileMRU`

在这种情况下，可以在以下位置找到最近的文件。此位置还保存了最近使用的文件的完整路径。

###  **打开/保存和上次访问的对话框 MRU：**

当我们打开或保存文件时，会出现一个对话框，询问我们从哪里保存或打开该文件。您可能会注意到，一旦我们在特定位置打开/保存文件，Windows 就会记住该位置。这意味着如果我们掌握了这些信息，我们就可以找出最近使用的文件。我们可以通过检查以下注册表项来做到这一点

`NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32\OpenSavePIDlMRU`

`NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\ComDlg32\LastVisitedPidlMRU`
`
###  **Windows 资源管理器地址/搜索栏：**

识别用户最近活动的另一种方法是查看 Windows 资源管理器地址栏中输入的路径或分别使用以下注册表项执行的搜索。

`NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\TypedPaths`

`NTUSER.DAT\Software\Microsoft\Windows\CurrentVersion\Explorer\WordWheelQuery`

### **用户帮助** ：

Windows 会在 User Assist 注册表项中跟踪用户使用 Windows 资源管理器启动的应用程序，以用于统计目的。这些项包含有关启动的程序、启动时间以及执行次数的信息。但是，在 User Assist 注册表项中找不到使用命令行运行的程序。User Assist 注册表项位于 NTUSER 配置单元中，映射到每个用户的 GUID。我们可以在以下位置找到它：

`NTUSER.DAT\Software\Microsoft\Windows\Currentversion\Explorer\UserAssist\{GUID}\Count`

### **ShimCache：**

ShimCache 是一种用于跟踪应用程序与操作系统兼容性的机制，可跟踪机器上启动的所有应用程序。它在 Windows 中的主要目的是确保应用程序的向后兼容性。它也被称为应用程序兼容性缓存 (AppCompatCache)。它位于 SYSTEM 配置单元中的以下位置：

`SYSTEM\CurrentControlSet\Control\Session Manager\AppCompatCache`

ShimCache 存储可执行文件的文件名、文件大小和最后修改时间。

### **AmCache：**

AmCache 配置单元是与 ShimCache 相关的工件。它执行与 ShimCache 类似的功能，并存储与程序执行相关的其他数据。这些数据包括执行路径、安装、执行和删除时间以及已执行程序的 SHA1 哈希值。此配置单元位于文件系统中的以下位置：

`C:\Windows\appcompat\Programs\Amcache.hve`

有关最后执行的程序的信息可以在配置单元中的以下位置找到：

`Amcache.hve\Root\File\{Volume GUID}\`

### **BAM/DAM**
会监控后台应用程序的活动。类似地，桌面活动调节器 (DAM) 是 Microsoft Windows 的一部分，可优化设备的功耗。这两者都是 Microsoft Windows 中现代待机系统的一部分。

在 Windows 注册表中，以下位置包含与 BAM 和 DAM 相关的信息。此位置包含有关上次运行的程序、其完整路径以及上次执行时间的信息。

`SYSTEM\CurrentControlSet\Services\bam\UserSettings\{SID}`

`SYSTEM\CurrentControlSet\Services\dam\UserSettings\{SID}`

### 设备标识：

以下位置跟踪插入系统的 USB 密钥。这些位置存储插入的 USB 设备的供应商 ID、产品 ID 和版本，可用于识别唯一设备。这些位置还存储设备插入系统的时间。

`SYSTEM\CurrentControlSet\Enum\USBSTOR`

`SYSTEM\CurrentControlSet\Enum\USB`

system\controlset001\control\Enum\USBSTOR`

主要是后面的文件 前面的可能会有些不同

### 第一次/最后一次：

类似地，以下注册表项跟踪设备首次连接的时间、最后一次连接的时间以及设备最后一次从系统中删除的时间。

`SYSTEM\CurrentControlSet\Enum\USBSTOR\Ven_Prod_Version\USBSerial#\Properties\{83da6326-97a6-4088-9453-a19231573b29}\####`

在此键中，可以用以下数字替换####符号以获取所需的信息：

|        |        |
| ------ | ------ |
| **价值** | **信息** |
| 0064   | 首次连接时间 |
| 0066   | 上次连接时间 |
| 0067   | 上次移除时间 |
### **USB 设备卷名：**

可以在以下位置找到所连接驱动器的设备名称：

`SYSTEM\`SOFTWARE\Microsoft\Windows Portable Devices\Devices`

虽然我们可以手动检查这个值，但正如我们上面看到的，注册表资源管理器已经解析了这些数据并向我们显示我们是否选择了 USBSTOR 键。

### 进程分析[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-20 "永久链接至标题")

- `netstat -ano` 查看是否打开了可疑端口
- `tasklist` 查看是否有可疑进程
- 分析开机自启程序
    
    - `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run`
    - `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Runonce`
    - `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServices`
    - `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce`
    - `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\policies\Explorer\Run`
    - `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`
    - `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce`
    - `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServices`
    - `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce`
    - `(ProfilePath)\Start Menu\Programs\Startup` 启动项
    - `msconfig` 启动选项卡
    - `gpedit.msc` 组策略编辑器
    
- 查看计划或定时任务
    
    - `C:\Windows\System32\Tasks\`
    - `C:\Windows\SysWOW64\Tasks\`
    - `C:\Windows\tasks\`
    - `schtasks`
    - `taskschd.msc`
    - `compmgmt.msc`
    
- 查看启动服务
    
    - `services.msc`
# linux日志
类Unix系统生成的常见日志  

###  重点分析位置
    
    - `/var/log/wtmp` 登录进入，退出，数据交换、关机和重启纪录
    - `/var/run/utmp` 有关当前登录用户的信息记录
    - `/var/log/lastlog` 文件记录用户最后登录的信息，可用 lastlog 命令来查看。
    - `/var/log/secure` 记录登入系统存取数据的文件，例如 pop3/ssh/telnet/ftp 等都会被记录。
    - `/var/log/cron` 与定时任务相关的日志信息
    - `/var/log/message` 系统启动后的信息和错误日志
    - `/var/log/apache2/access.log` apache access log
    - `/etc/passwd` 用户列表
    - `/etc/init.d/` 开机启动项
    - `/etc/cron*` 定时任务
    - `/tmp` 临时目录
    - `~/.ssh`

### 用户分析[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-16 "永久链接至标题")

- `/etc/shadow` 密码登陆相关信息
- `uptime` 查看用户登陆时间
- `/etc/sudoers` sudo用户列表

### 进程分析[](https://websec.readthedocs.io/zh/latest/defense/emergency.html#section-17 "永久链接至标题")

- `netstat -ano` 查看是否打开了可疑端口
- `w` 命令，查看用户及其进程
- 分析开机自启程序/脚本
    
    - `/etc/init.d`
    - `~/.bashrc`
    
- 查看计划或定时任务
    
    - `crontab -l`
    
- `netstat -an` / `lsof` 查看进程端口占用
### linux日志类型
两种主要类型的日志机制：内核和用户。

- **内核**日志（**Kernel**）提供了系统内部运作的后台通道。它们包括与硬件事件、驱动程序操作和系统错误相关的消息。
- 内核日志存储在由**rsyslog**或**syslog**`/var/log/kern.log`

- **用户** 日志（user）记录用户、应用程序和操作系统之间的交互。其中包括登录尝试、命令执行和特定于应用程序的活动。

###  kern.log 和 dmesg

`/var/log/kern.log`文件专门用于记录内核消息。此日志对于诊断硬件故障和了解攻击者可能利用的更深层次的系统问题至关重要。

`/var/log/dmesg`文件。检查此日志可以帮助您检测系统启动期间的异常消息，这些消息可能表示篡改或硬件问题。

### **认证日志**

`/var/log/auth.log`系统上所有与身份验证相关的事件的首选。它记录每次登录尝试（无论成功还是失败），以及使用提升权限和SSH登录执行的命令。这使它成为跟踪潜在安全漏洞的宝贵资源。

### 系统日志

`/var/log/syslog`文件可汇总各种系统消息，是了解系统范围事件的中心点。此日志可捕获从 cron 作业执行到内核活动的所有内容，从而全面了解系统的健康状况和活动。

我们可以通过搜索包含“ **CRON** ”的条目来查看 syslog 中的 cron 作业执行情况。这可以帮助您验证计划任务是否按预期运行，并识别任何可疑或未经授权的 cron 作业。 

系统日志中的 Cron 作业执行

```shell-session
ubuntu@tryhackme:~$ grep 'CRON' /var/log/syslog
```

 syslog 查看内核相关的消息。这些条目可能表明硬件问题或针对内核的潜在攻击。通过运行`grep 'kernel' /var/log/syslog`筛查

### btmp 和 wtmp

`/var/log/btmp`文件记录失败的登录尝试，

`/var/log/wtmp`记录每次登录和注销活动。我们可以确信，这些文件对于识别潜在的暴力攻击和跟踪未经授权的访问至关重要，类似于 该`/var/log/auth.log`文件。

评估
### 日志级别

Linux日志具有不同的重要性级别，这有助于根据严重性对消息进行分类，并允许管理员和分析师确定其操作的优先级。Linux使用的级别包括：

| 级别名称           | 描述                               |
| -------------- | -------------------------------- |
| 紧急情况 EMERGENCY | 当系统无法使用或者崩溃时，消息采用最高级别。           |
| 警报 ALERT       | 提供需要用户立即注意的信息。                   |
| 批判的 CRITICAL   | 提供有关严重错误的信息，无论是硬件还是软件相关。         |
| 错误 ERROR       | 通知用户有关非严重错误，例如设备识别失败或与驱动程序相关的问题。 |
| 警告 WARNING     | 显示有关非紧急错误的警告的默认日志级别。             |
| 注意 NOTICE      | 通知值得关注的事件。                       |
| 信息 INFO        | 提供有关系统动作和操作的信息性消息。               |
| 调试 DEBUG       | 用于调试的详细信息，大多与开发或故障排除期间相关。        |

### **明文格式的日志**  

可以使用多种工具查看和分析明文日志，如上表所示。  

|- 常规系统日志<br>    <br>    - `/var/log/syslog`<br>    - `/var/log/messages`|- 系统启动日志<br>    <br>    - `/var/log/boot.log`|- **后台守护进程日志**<br>    <br>    - `/var/log/daemon.log`|
|---|---|---|
|- **身份验证日志**<br>    <br>    - `/var/log/auth.log`<br>    - `/var/log/secure`|- **内核日志**<br>    <br>    - `/var/log/kern.log`|- **审计日志**<br>    <br>    - `/var/log/audit`|
|- Cron 守护进程日志<br>    <br>    - `/var/log/cron.log`|- 调试日志<br>    <br>    - `/var/log/debug`|- **Apt命令日志**<br>    <br>    - `/car/log/apt/`|
### 二进制格式的日志

**日志需要特定二进制文件才能查看**  

一些二进制格式的日志只有使用相应的工具才能查看和分析。

|- 仅限登录失败<br>    <br>    - `/var/log/faillog`<br><br>- 命令： `faillog`|- 活动登录记录<br>    <br>    - `/var/log/wtmp`<br><br>- 命令： `who`|
|---|---|
|- 上次登录<br>    <br>    - `/var/log/lastlog`<br><br>- 命令： `lastlog`|- 内核环形缓冲区日志<br>    <br>    - `/var/log/dmesg`<br><br>- 命令： `dmesg`|
### syslog日志结构

[Syslog 日志文件结构由RFC 5424](https://www.rfc-editor.org/rfc/rfc5424.html)  - [5426](https://www.rfc-editor.org/rfc/rfc5426.html)定义。
此外，它被广泛使用，并且易于用 tail 和 grep 等原生细粒度系统工具处理。下表说明了结构详细信息。  

|   |   |
|---|---|
|**时间戳**|- 事件发生的日期和时间信息。|
|**主机名**|- 创建该消息的机器名称。|
|**申请/流程**|- 创建消息的应用程序。|
|**进程 ID**|- 创建该消息的应用程序的进程 ID 号。|
|**消息 ID**|- 标识消息类型的消息 ID。<br>    - 示例：入站TCP连接：TCPIN|
|**信息**|- 消息本身。<br>- 采用 UTF-8 编码|

## apache日志

Apache日志

|                        |                                                                                                                                                                                                   |
| ---------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **格式  <br>/  <br>扩展名** | - 默认格式/扩展名：<br>    - `.log`                                                                                                                                                                       |
| **文件位置**               | - 日志文件的目录可能因使用的服务和配置文件而异。不过，大多数类 Unix 操作系统都共享相同的目录来存储日志文件。<br>- 主目录<br>    - `/var/log/apache2/`<br>- 访问日志<br>    - `/var/log/apache2/access.log`<br>- 错误日志<br>    - `/var/log/apache2/error.log` |
| **查看工具**               | - 默认：<br>    - 系统日志查看器<br>- 可以使用其他工具和实用程序来查看明文日志文件。<br>    - 航航  <br>        <br>    -cat，tail，more，less，grep，awk                                                                                 |

### Apache access.log 
“组合日志格式”的结构详细说明在给定的表中。  

|          |                    |                                                                     |
| -------- | ------------------ | ------------------------------------------------------------------- |
| **知识产权** | ％h                 | - 客户端（请求者）的 IP 地址。                                                  |
| **没有信息** | ％l                 | - 它代表“连字符”（-）。<br>- 当所请求的信息不可用时，就会出现此信息。                            |
| **用户身份** | ％u                 | - 用户 ID 信息。<br>- 这是基于HTTP身份验证的，因此如果请求代码是 401（身份验证失败或仍需要完成），则此信息不可靠。 |
| **时间戳**  | ％t                 | - 收到请求的时间信息。                                                        |
| **要求**   | \"％r\"             | - 请求。<br>- 以双引号记录。                                                  |
| **地位**   | %> s               | - 发送回客户端的状态代码。                                                      |
| **对象大小** | ％b                 | - 返回对象的大小。<br>- 它不包括响应标头。                                           |
| **引荐来源** | \"%{Referer}i\"    | - HTTP referer 字段用于标识用于到达当前页面的先前资源。                                 |
| **用户代理** | \"%{User-agent}i\" | - User-Agent 字段标识发送请求的应用程序和操作系统。                                    |
### Apache error.log 
结构详细说明如表所示。  

|            |     |                    |
| ---------- | --- | ------------------ |
| **时间戳**    | ％t  | - 收到请求的时间信息。       |
| **等级**     | ％l  | - 消息的日志级别。         |
| **进程 ID**  | ％P  | - 如果是当前进程，则为进程 ID。 |
| **源文件**    | %F  | - 日志调用的源文件和行号      |
| **错误状态**   | ％E  | - 错误状态代码。          |
| **客户端 IP** | ％a  | - 客户端的 IP 和端口信息。   |
| **实际日志消息** | ％M  | - 实际的日志消息。         |

## linux日志位置

#### 常见日志文件位置

日志分析的一个重要方面是了解各种应用程序和系统生成的日志文件的位置。虽然日志文件路径可能因系统配置、软件版本和自定义设置而异，但了解常见的日志文件位置对于有效调查和威胁检测至关重要。

- **Web 服务器：**
    - **Nginx：**
        - 访问日志：`/var/log/nginx/access.log`
        - 错误日志：`/var/log/nginx/error.log`
    **-apache：**
        - 访问日志：`/var/log/apache2/access.log`
        - 错误日志：`/var/log/apache2/error.log`

- **数据库：**
    - **MySQL：**
        - 错误日志：`/var/log/mysql/error.log`
    - **PostgreSQL：**
        - 错误和活动日志：`/var/log/postgresql/postgresql-{version}-main.log`

- **Web 应用程序：**
    - **PHP：**
        - 错误日志：`/var/log/php/error.log`

- **操作系统：**
    - **Linux：**
        - 常规系统日志：`/var/log/syslog`
        - 身份验证日志：`/var/log/auth.log`

- **防火墙和IDS / IPS：**
    - **iptables：**
        - 防火墙日志：`/var/log/iptables.log`
    - **Snort**：
        - Snort 日志：`/var/log/snort/`

## **异常用户行为**

可以识别的主要模式之一与不寻常或异常的用户行为有关。这指的是用户进行的任何偏离其典型或预期行为的动作或活动。

为了有效检测异常用户行为，组织可以采用结合检测引擎和机器学习算法的日志分析解决方案来建立正常行为模式。然后可以将偏离这些模式或基线的行为作为潜在安全事件发出警报。这些解决方案的一些示例包括[_Splunk用户行为分析 ( UBA )_](https://www.splunk.com/en_us/products/user-behavior-analytics.html)、_[IBM QRadar UBA](https://www.ibm.com/docs/en/qradar-common?topic=app-qradar-user-behavior-analytics)_和_[Azure AD Identity Protection](https://learn.microsoft.com/en-us/azure/active-directory/identity-protection/overview-identity-protection)_。

具体指标可能因来源不同而有很大差异，但可以在日志文件中找到一些示例，包括：

- **多次登录尝试失败**
    - 短时间内登录失败次数异常高可能表示存在暴力攻击。
    
- **异常登录时间**
    - 用户典型访问时间或模式之外的登录事件可能表示未经授权的访问或帐户被盗用。
    
- **地理异常**
    - 来自用户通常不访问的国家/地区的 IP 地址的登录事件可能表明潜在的帐户泄露或可疑活动。
    - 此外，从不同地理位置同时登录（或有迹象表明无法旅行）可能表明存在帐户共享或未经授权的访问。

- **频繁更改密码**
    - 日志事件表明用户的密码在短时间内频繁更改，这可能表明有人试图隐藏未经授权的访问或接管帐户。
    
- **不寻常的用户代理字符串**
    - 在HTTP流量日志的上下文中，来自具有与其典型浏览器不同的不常见用户代理字符串的用户的请求可能表示自动攻击或恶意活动。
    - 例如，默认情况下，[Nmap扫描器将记录包含“](https://tryhackme.com/room/furthernmap) Nmap脚本引擎”的用户代理。默认情况下，[Hydra暴力破解工具将在其用户代理中包含“(](https://tryhackme.com/room/hydra) Hydra )”。这些指标在日志文件中很有用，可以检测潜在的恶意活动。

这些异常的严重性可能因具体情况和现有系统而有很大差异，因此必须微调任何自动异常检测机制以尽量减少误报。

# 常见攻击特征

识别日志数据中的常见攻击特征是检测和快速应对威胁的有效方法。攻击特征包含威胁行为者留下的特定模式或特征。它们可能包括恶意软件感染、基于 Web 的攻击（SQL注入、跨站点脚本、目录遍历）等。由于这完全取决于攻击面，因此一些高级示例包括：

## 1. SQL注入

SQL注入试图利用与数据库交互的 Web 应用程序中的漏洞。在应用程序或数据库日志中查找异常或格式错误的SQL查询，以识别常见的SQL注入攻击模式。

可疑的SQL查询可能包含意外字符，例如单引号 ( `'`)、注释 ( `--`, `#`)、联合语句 ( `UNION`) 或基于时间的攻击 ( `WAITFOR DELAY`, `SLEEP()`)。可[在此处](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)找到有用的SQLi有效负载列表以供参考。[](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)

在以下示例中，可以通过查询参数的部分识别SQL注入尝试。攻击者似乎已使用单引号转义 SQL 查询，并注入 union select 语句以从数据库表中检索信息。通常，此有效负载可能是 URL 编码的，需要额外的处理步骤才能有效识别它。`' UNION SELECT``q=``users`sql。日志

```plaintext
10.10.61.21 - - [2023-08-02 15:27:42] "GET /products.php?q=books' UNION SELECT null, null, username, password, null FROM users-- HTTP/1.1" 200 3122
```

## 2. 跨站脚本（XSS）

利用跨站点脚本 ( XSS ) 漏洞，攻击者可以将恶意脚本注入网页。要识别常见的XSS攻击模式，查找包含脚本标记 ( `<script>`) 和事件处理程序 ( `onmouseover`, `onclick`, ) 的意外或异常输入的日志条目通常很有帮助。可[在此处](https://github.com/payloadbox/xss-payload-list)`onerror`找到有用的XSS有效负载列表以供参考。[](https://github.com/payloadbox/xss-payload-list)

在下面的例子中 ，可以通过插入到参数中的payload来识别跨站脚本尝试，这是XSS漏洞的常用测试方法。`<script>alert(1);</script>``search`跨站脚本。日志

```plaintext
10.10.19.31 - - [2023-08-04 16:12:11] "GET /products.php?search=<script>alert(1);</script> HTTP/1.1" 200 5153
```

## 3. 路径遍历

利用路径遍历漏洞，攻击者可以访问 Web 应用程序预期目录结构之外的文件和目录，从而导致未经授权访问敏感文件或代码。要识别常见的遍历攻击模式，请查找遍历序列字符（`../`和`../../`）以及访问敏感文件的迹象（`/etc/passwd`， ）。可[在此处](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Directory%20Traversal/README.md)`/etc/shadow`找到有用的目录遍历负载列表以供参考。[](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Directory%20Traversal/README.md)

需要注意的是，与上述示例一样，目录遍历通常经过 URL 编码（或双重 URL 编码），以避免被防火墙或监控工具检测到。因此，`%2E`和`%2F`是有用的 URL 编码字符，因为它们分别指代`.`和`/`。

在下面的例子中，可以通过重复的字符序列识别目录遍历尝试`../`，表明攻击者正试图“退出”Web 目录并访问`/etc/passwd`服务器上的敏感文件。


```plaintext
10.10.113.45 - - [2023-08-05 18:17:25] "GET /../../../../../etc/passwd HTTP/1.1" 200 505
```

## 日志查询和排查

[RegExr](https://regexr.com/)是一款在线工具，可帮助教授、构建和测试正则表达式模式。要继续操作，请复制上述日志条目并将其粘贴到该工具的“**文本”部分。**

linux中的 cat，less，more，tail，wc，cut，sort，uniq，sed，wak，grep

wc统计字符 词
[[linux的命令#^382674]]

cut命令根据指定的分隔符从文件中提取特定列（字段）
[[linux的命令#^248876]]

uniq命令
[[linux的命令#^b7e319]]

awk命令
[[linux的命令#^599482]]

grep命令
[[linux的命令#^94b231]]


# linux实时分析

## 取证
### **1. 正在运行的进程**

**解释：**

- 有关正在运行的进程的信息对于任何取证调查都至关重要。这包括有关当前在系统上运行的所有进程的信息，例如它们的进程ID (PID)、命令行参数、所有者-用户ID以及父子进程关系。

**取证价值：**

- 这些数据可以帮助调查人员了解捕获期间执行了哪些程序和脚本，从而表明正常操作或恶意活动。

### **2. 打开文件**  **Open Files**

**解释**

- 当前由不同进程打开的文件列表。

**取证价值**  

- 打开的文件可以揭示正在访问或修改的数据，这对于了解攻击或数据泄露的背景至关重要。

###  **3. 内存数据结构**  **In-Memory Data Structures**

**解释**

- 包含系统和应用程序状态信息的内核结构、进程堆和堆栈。

**取证价值**  

- 这些结构可能包含敏感信息，例如加密密钥、密码或内存损坏漏洞的证据。

### **4. 网络连接**  **Network Connections**

**解释**

- 有关正在进行的网络连接的详细信息，包括 IP 地址、端口和连接状态（例如已建立、正在监听、已关闭）。

**取证价值**

- 这些信息可以揭示与可疑 IP 地址的连接或正在进行的数据泄露。

### **5. 监听服务**  **Listening Services**

**解释**

- 当前正在监听传入网络连接的服务。

**取证价值**

- 识别这些服务有助于确定正在运行哪些可通过网络访问的应用程序，其中可能包括未经授权的后门或受损的服务。

### **6. 登录用户会话**   **Logged-in User Sessions**

**解释**

- 有关当前登录系统的用户、他们的登录时间以及他们正在使用的终端的信息。

**取证价值**

- 了解谁登录有助于将用户活动与观察到的事件关联起来，并可以指示未经授权的访问。

### **7. 用户活动** **User Activity**

**解释**

- 用户执行的命令的记录，例如 shell 历史记录。

**取证价值**

- 这些数据有助于追踪用户的行为，可能揭示攻击者采取的步骤或导致事件的一系列行为。

### **8.内存日志** **In-Memory Logs**

**解释**

- 在写入磁盘之前临时存储在内存中的日志。

**取证价值**

- 这些日志可以在被永久记录之前提供系统事件和应用程序行为的实时快照，其中可能包括攻击的痕迹。

### **9.接口配置**  **Interface Configurations**

**解释**

- 网络接口的当前配置和运行状态，包括 IP 地址、MAC 地址和路由信息。  
    

**取证价值**

- 这些数据有助于了解系统的网络环境，包括任何可能表明恶意活动的网络设置变化。

### **10.临时文件和缓存** **Temporary Files and Cache**

**解释**

- 存储在临时目录（如`/tmp`和 `/var/tmp`）中的文件。

**取证价值**

- 临时文件可能包含来自应用程序的临时数据，例如攻击中使用的敏感文档或脚本的临时副本。

## 系统分析

调查的第一步是尽可能多地获取有关受感染机器的详细信息。这将使我们清楚地了解系统是什么样子，以及它的状态如何。

系统分析是任何取证调查中的关键步骤，用于识别和定位有关系统的重要信息，包括收集以下信息：

- 系统配置
- 登录用户
- 已安装的应用程序
- 硬件配置

### 基本信息

#### 1. **基本系统信息**

**说明：**使用以下命令提取有关系统的基本信息，如下所示。此命令输出提供有关系统的全面详细信息，包括其内核版本、架构、主机名以及编译内核的日期和时间。  

**命令：** `uname -a`

#### 2. **主机名**  

**说明：**Linux中的命令`hostnamectl`用于查询和更改系统主机名和相关设置。当我们运行此命令时，它会显示有关系统主机名和其他相关详细信息的详细信息，如下所示：  

以下命令提供有关主机名和相关设置的详细信息。

**命令**：`hostnamectl`

#### 3. **正常运行时间**  

**说明：**此`uptime`命令可快速快照系统当前状态，包括时间、运行时间、登录用户数以及系统繁忙程度。示例如下：  

**命令**：**`uptime`**

#### 4. **硬件信息**  

**解释：**Linux中的命令`lscpu`显示有关CPU架构的详细信息。

**命令：** **`lscpu`**

#### 5. **磁盘可用空间  

**说明：**此命令报告系统上已用和可用的磁盘空间量。

**命令：** `df -h`

#### 6. **免费存储**

**命令：**  **`free`**

**说明：**Linux中的命令`free -h`用于以人类可读的格式显示内存使用信息。

### debian软件包

#### **1. dpkg**

**命令**：  **`dpkg -l`**

**说明：** `dpkg`是系统直接使用的低级软件包管理工具，用于安装、删除和提供有关 .deb 软件包的信息。让我们使用以下命令列出已安装的软件包。

#### 2. `apt`
处理依赖关系，自动从存储库下载并安装软件包，并解决冲突。

apt list --installed

#### 3. **`ip r`**或 **`route`**

**说明：**显示路由表。

## 进程分析

| 命令        | 解释                                                                |
| --------- | ----------------------------------------------------------------- |
| `ps`      | 它提供了当前进程的快照。这对于概览所有正在运行的进程非常有用，并且各种选项允许您显示更详细的信息。                 |
| `top`     | 提供正在运行的进程的动态实时视图。它监控系统性能和资源使用情况，显示哪些进程消耗最多的 CPU 和内存。              |
| `htop`    | 此命令与此类似，`top`但界面有所改进，功能也更多。它使流程管理更加轻松，并包含颜色编码以提高可读性。              |
| `pstree`  | 它以树状形式显示进程，显示进程之间的父子关系。这有助于我们了解进程之间的关系和组织方式。                      |
| `pidof`   | 它用于通过名称查找正在运行的程序的进程 ID (PID)。当您知道进程的名称并需要其 PID 以进行进一步调查或操作时，这很有用。 |
| `pgrep`   | 此工具根据名称和其他属性搜索进程。它对于筛选和查找特定进程很有用。                                 |
| `lsof`    | 此工具列出打开的文件以及打开这些文件的进程。这有助于确定哪些进程使用了​​特定的文件、套接字或网络连接。              |
| `netstat` | 它提供与网络相关的信息，包括活动连接和监听端口。这对于识别进程的潜在恶意网络活动非常有用。                     |
| `strace`  | 跟踪系统调用和信号。这是一项高级功能，但对于调试和准确了解进程在底层执行的操作非常有用。                      |
| `vmstat`  | 报告虚拟内存统计信息。它有助于了解系统性能概况，包括进程调度和资源使用情况。                            |
## 寻找可疑进程

### 1. **列出正在运行的进程**

首先，使用以下命令列出所有正在运行的进程。显示主机上运行的进程列表

**搜索查询：** `SELECT pid, name, path, state FROM processes;`

### 2. 寻找/tmp中的异常进程

入侵者从 tmp 目录运行恶意程序以避免被发现是很常见的。让我们更新查询以查看是否有任何进程从 tmp 目录执行。

**Query:** `SELECT pid, name, path FROM processes WHERE path LIKE '/tmp/%' OR path LIKE '/var/tmp/%';`

### 3. 寻找无文件恶意软件/进程

攻击者往往会在执行二进制文件后将其从磁盘中删除，以避免留下痕迹。Rootkit 和其他隐身恶意软件经常使用隐藏进程来避免被发现。**  
  
搜索查询：** `SELECT pid, name, path, cmdline, start_time FROM processes WHERE on_disk = 0;`

**解释：**此命令将列出在主机上执行但不在磁盘上执行的进程。这也可能表明存在潜在的无文件恶意软件。

`on_disk`可以有两个值：`1`表示它在磁盘上，`0`表示进程不在磁盘上。

无文件恶意软件具有以下我们可以观察到的特征：

- **无磁盘占用：**它不会在磁盘上留下文件，因此更难使用传统的基于文件的防病毒和安全解决方案进行检测。
- **驻留内存：**完全在系统内存中运行。
- **持久性：**您可以使用计划任务或其他方式实现持久性，而无需将文件放在磁盘上。

### 4. Orphan Processes 孤儿进程
Linux 中的每个进程都有一个父进程。这种父子关系形成一个进程树，可以通过`pstree`工具查看。入侵者可以创建一个成为孤儿的进程。这可能表明攻击者意图可疑，因为创建孤儿进程可以成为攻击者隐藏其活动、保持持久性和逃避检测的有用工具。

**搜索查询：** `SELECT pid, name, parent, path FROM processes WHERE parent NOT IN (SELECT pid from processes);`

**解释：**此命令将列出没有父进程并因此被视为孤立的进程。

### 5. 查找从用户目录启动的进程

在服务器上下文中，如果进程从用户目录运行，则该进程可能会被标记为需要进一步调查。主要原因之一是，通常，系统进程从标准系统目录运行。让我们使用以下搜索查询来查找从用户目录运行的进程。  

**搜索查询：** `SELECT pid, name, path, cmdline, start_time FROM processes WHERE path LIKE '/home/%' OR path LIKE '/Users/%';`

## 网络连接

### 命令工具
|**命令**|**描述**|
|---|---|
|`netstat`|它显示网络连接、路由表、接口统计信息、伪装连接和多播成员资格，这对于获取当前网络状态的快照很有用。|
|`ss`|与 类似`netstat`，但速度更快，更详细。它会转储套接字统计信息并显示活动连接和监听端口。|
|`tcpdump`|实时捕获并分析网络数据包。您可以将这些数据包保存到文件中以供日后分析，或对其进行过滤以关注特定类型的流量。|
|`iftop`|它实时显示接口的带宽使用情况。这对于查看哪些连接占用的带宽最多非常有用。|
|`lsof`|列出打开的文件，包括网络连接。它有助于查看哪些进程连接到网络以及它们正在使用哪些端口。|
|`iptables`|它显示、设置和维护 IP 数据包过滤规则，帮助管理防火墙规则，并监控网络流量。|
|`nmap`|它扫描网络以发现主机和服务。这对于识别网络上的设备及其使用的端口非常有用。|
|`ping`|它通过发送 ICMP 回显请求数据包来测试与其他网络设备的连接。它对于检查主机是否可访问非常有用。|
|`traceroute`|跟踪数据包到达目的地所经过的路径。它有助于识别可能发生网络延迟或问题的位置。|
|`dig`|向 DNS 服务器查询有关域名的信息。它有助于诊断与 DNS 相关的问题。|
|`hostname`|显示或设置系统的主机名和关联的 IP 地址。它对于识别本地系统的网络身份很有用。|
|`ifconfig`|配置网络接口。虽然在现代系统中它已被大量命令取代`ip`，但它对于显示有关网络接口的信息仍然很有用。|
|`ip`|更强大、更通用的替代品`ifconfig`。它可用于配置接口、路由和隧道。|
|`arp`|显示和修改系统的ARP（地址解析协议）表。它对于将 IP 地址与 MAC 地址关联很有用。|
|`route`|显示或修改 IP 路由表。它有助于了解数据包如何通过网络路由。|
|`curl`|使用各种协议从服务器传输数据或向服务器传输数据。它对于测试网络连接和下载文件很有用。|
|`wget`|非交互式网络下载器。它主要用于从网络下载文件，可用于测试下载速度和连接性。|
|`netcat`|使用 TCP 或 UDP 通过网络连接读取和写入数据。它是一款用于调试和测试网络连接的多功能工具。|
|`whois`|查询 WHOIS 数据库以获取域名注册信息。这对于收集有关域名所有者的信息很有用。|
|`nslookup`|查询 DNS 服务器以获取域名或 IP 地址映射。这对于诊断 DNS 问题很有用。|


### **网络连接**

从调查的角度来看，检查正在进行的网络通信或过去的连接可能是解决案件的关键。  
**查询：** `SELECT pid, family, remote_address, remote_port, local_address, local_port, state FROM process_open_sockets LIMIT 20;`  

**说明：**此查询检索有关系统上各个进程建立的网络连接的信息。它从`process_open_sockets`表中选择条目。

### **远程连接**

该主机上建立的远程网络连接可以帮助识别潜在的C2服务器通信。我们将使用以下命令列出所有具有远程连接的网络连接。

**搜索查询：**`SELECT pid, fd, socket, local_address, remote_address, local_port, remote_port FROM process_open_sockets WHERE remote_address IS NOT NULL;`

### **检查DNS查询**

使用以下查询来检索有关此主机上的DNS查询的信息。  
  
**搜索查询：**`SELECT * FROM dns_resolvers;`

### **列出网络接口**

使用以下查询来检索有关网络接口的信息。  

**搜索查询：**`SELECT * FROM interface_addresses;`

### **列出网络连接**

让我们使用以下命令列出监听端口。  

**搜索查询：** `SELECT * FROM listening_ports;`

## 磁盘文件

####  查询列出所有打开的文件。  

**搜索查询**：`SELECT pid, fd, path FROM process_open_files;`

**解释：**此查询将列出已打开并与某个进程关联的所有文件。我们可以通过它们各自的pid来找到它们。

####  从 tmp 目录访问的文件

我们可以通过过滤查询来缩小结果范围，仅显示从`/tmp/`目录访问的文件。

**搜索查询：** **说明**：此查询将搜索已打开系统文件的进程。对于此查询，我们仅查看从目录访问的文件。在实际调查中，我们将不得不查看其他各个位置。`SELECT pid, fd, path FROM process_open_files where path LIKE '/tmp/%';`  
  
#### 隐藏文件

在主机上隐藏文件是一种常见的做法。但是，如果攻击者不想让用户看到可疑文件，他们也可能将可疑文件的模式更改为隐藏。我们将使用以下命令查看根目录中是否存在隐藏的文件或目录。  

**搜索查询：** `SELECT filename, path, directory, size, type FROM file WHERE path LIKE '/.%';`  

**解释：**此查询将检查根目录以追踪隐藏的文件或文件夹。在实际调查中，我们还需要检查其他位置。

#### 最近修改的文件

让我们使用以下命令来查看最近修改了哪个文件。

**搜索查询**：`SELECT filename, path, directory, type, size FROM file WHERE path LIKE '/etc/%' AND (mtime > (strftime('%s', 'now') - 86400));`

#### 最近修改的二进制文件

与文件类似，攻击者倾向于修改系统二进制文件并将恶意代码注入其中以避免被发现。此查询将查看修改时间并查看最近修改了哪个二进制文件。

**搜索查询：** `SELECT filename, path, directory, mtime FROM file WHERE path LIKE '/opt/%' OR path LIKE '/bin/' AND (mtime > (strftime('%s', 'now') - 86400));`

### 寻找后门账户

创建后门账户是各种 APT 组织在网络中立足的常见做法。让我们使用以下命令检查可用用户，看看是否能找到任何奇怪的账户。

**搜索查询**：`select username, directory from users;`  

### 调查初始化服务  

攻击者会通过多种方式在受感染的主机上启动服务以保持持久性并避免被发现。所有服务都放置在路径上`/etc/systemd/system`。

### crontab
crontab -l 检查定时任务

# linux进程分析

[[linux的命令#^c73690]]


Cronjobs 是cron 守护进程按照预定义的时间间隔自动执行的计划任务。cron 守护进程是一个后台进程，负责根据配置文件（称为 crontabs）管理 cronjobs。用户可以将自己的 crontab 文件存储在/var/spool/cron/crontabs目录中。主 crontab 文件/etc/crontab管理整个系统的 cronjobs。

系统级`/etc/crontab`crontab 与用户级 crontab 不同

## Cron配置文件

我们可以通过首先盘点系统的 cron 配置文件来开始调查系统中的 cronjobs。幸运的是，这个过程相对简单，因为这些文件通常存储在已知位置。

### 1. **/etc/crontab**

首先，让我们关注`/etc/crontab`系统范围 cronjobs 的主要存储库。管理员可以在此文件中配置需要提升权限的任务，通常以 root 用户身份执行命令

位于`/etc/`具有以下命名约定的目录下：

- **/etc/cron.hourly/** — 每小时运行一次的系统 cronjobs。
- **/etc/cron.daily/** — 每天运行一次的系统 cronjobs。
- **/etc/cron.weekly/** — 每周运行一次的系统 cronjobs。
- **/etc/cron.monthly/** — 每月运行一次的系统 cronjobs。
- **/etc/cron.d/** — 额外的自定义系统 cronjobs。

### 2. **/var/spool/cron/crontabs/**

在研究了系统级 cronjobs 之后，可以查看用户在系统上配置的各种用户级 cronjobs。用户级 cronjobs 特定于单个用户配置文件，并且独立于系统范围的 cronjobs 进行管理。

sudo ls -al /var/spool/cron/crontabs/

列出用户级cronjobs

## Cron 执行日志

Cron 日志记录由 cron 守护程序管理的计划任务的执行情况，并提供按时间顺序排列的 cron 作业执行时间记录，以及任何相关输出或错误消息。

cron 执行日志通常存储在 中`/var/log/syslog`

# 服务 
## systemctl命令
```
sudo systemctl list-units --all --type=service
```

列出系统上所有的服务

## 安装日志
**记录软件包管理操作的核心日志文件** 在里面可以查看安装过的记录

```bash
/var/log/dpkg.log
```

### 检查服务日志

服务日志文件包含有关系统上服务所生成的活动、状态和错误的宝贵信息。这些日志对于分析师在事件期间调查服务时非常有用。从 systemd 日志（systemd 日志服务）查询和查看服务日志的最简单方法是通过`journalctl`命令。

## **系统范围的自动启动脚本**

这些脚本在操作系统启动时、用户登录前执行。它们通常位于`/etc/init.d/`、`/etc/rc.d/`或 等目录中`/etc/systemd/system/`。系统范围的自动启动脚本通常用于启动系统服务或守护进程.

### **用户特定的自动启动脚本**

**这些脚本在用户**登录其帐户时执行。它们通常位于`~/.config/autostart/`或等目录中`~/.config/`（在各个子目录下）

## 识别系统自动启动脚本

**/etc/init.d/**

**/etc/systemd/system/**

## 识别用户自动启动脚本

**~/.config/autostart/**

## application
存储的命令历史记录`.viminfo`提供了用户执行的命令的按时间顺序的记录，可以作为重建用户活动的宝贵资源。

